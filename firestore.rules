rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------------------------
       USERS & ROLES
    ---------------------------- */
    match /roles/{uid} {
      allow read: if request.auth != null;
      allow write: if false; // no one writes roles from client
    }

    /* ---------------------------
       STUDENTS (ADMIN ONLY)
    ---------------------------- */
    match /students/{studentId} {
      // Admins only
      allow create, update, delete: if request.auth != null
        && get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == "admin";

      // Teachers & admins can read
      allow read: if request.auth != null;
    }

    /* ---------------------------
       ATTENDANCE (TEACHER OR SCANNER)
    ---------------------------- */
    match /attendance/{docId} {
      allow read: if request.auth != null;

      // write allowed for teachers OR admins
      allow create, update: if request.auth != null &&
        (
          get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == "teacher" ||
          get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == "admin"
        );
      
      // No deletes from client
      allow delete: if false;
    }

    /* ---------------------------
       DAILY ATTENDANCE (Cloud Functions only)
    ---------------------------- */
    match /dailyAttendance/{day} {
      allow read: if request.auth != null;

      // Only cloud functions can write
      allow write: if request.time.toMillis() < 0; // impossible â†’ denies all
    }
  }
}
