<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karate Attendance App</title>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- HTML5 QR Code Library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

  <!-- LOGIN VIEW -->
  <div id="loginView" class="container">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Enter email" required>
    <input type="password" id="password" placeholder="Enter password" required>
    <button onclick="login()">Login</button>
    <p id="loginMsg" style="color:red; text-align:center; margin-top:10px;"></p>
  </div>

  <!-- ADMIN VIEW -->
  <div id="adminView" class="container" style="display:none;">
    <h2>Admin Dashboard</h2>
    <input type="text" id="studentName" placeholder="Student Name">
    <input type="text" id="studentBelt" placeholder="Belt Color">
    <input type="text" id="studentId" placeholder="Student ID">
    <button onclick="addStudentUI()">Add Student</button>
    <h3>Student List</h3>
    <div id="studentList"></div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- TEACHER VIEW -->
  <div id="teacherView" class="container" style="display:none;">
    <h2>Teacher Dashboard</h2>
    <div id="reader" style="width:300px; margin:auto;"></div>
    <p id="scanMsg" style="text-align:center; color:green;"></p>
    <h3>Attendance</h3>
    <table>
      <thead>
        <tr>
          <th>Student ID</th>
          <th>Name</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="attendanceTable"></tbody>
    </table>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- Firebase + App JS -->
  <script type="module">
    import { loginUser, logoutUser, getUserRole, addStudent, deleteStudent, getAllStudents, markAttendance, autoRedirect } from "./assets/app.js";

    // DOM Elements
    const loginView = document.getElementById("loginView");
    const adminView = document.getElementById("adminView");
    const teacherView = document.getElementById("teacherView");

    const loginMsg = document.getElementById("loginMsg");
    const studentListDiv = document.getElementById("studentList");
    const attendanceTable = document.getElementById("attendanceTable");
    const scanMsg = document.getElementById("scanMsg");

    let html5QrcodeScanner;

    // Login
    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      loginMsg.innerText = "";

      if (!email || !password) { loginMsg.innerText="Enter email & password"; return; }

      try {
        const userCredential = await loginUser(email, password);
        const user = userCredential.user;
        const role = await getUserRole(user.uid);

        if (role === "admin") {
          showAdminView();
        } else if (role === "teacher") {
          showTeacherView();
        } else {
          loginMsg.innerText = "You are not allowed to login.";
        }

      } catch (error) {
        loginMsg.innerText = "Login failed: " + error.message;
      }
    }

    // Logout
    async function logout() {
      if(html5QrcodeScanner) html5QrcodeScanner.stop();
      await logoutUser();
      adminView.style.display = "none";
      teacherView.style.display = "none";
      loginView.style.display = "block";
    }

    // Show Admin
    async function showAdminView() {
      loginView.style.display = "none";
      adminView.style.display = "block";
      await loadStudents();
    }

    // Show Teacher
    async function showTeacherView() {
      loginView.style.display = "none";
      teacherView.style.display = "block";
      await loadAttendance();
      startQRScanner();
    }

    // Load students for admin
    async function loadStudents() {
      const students = await getAllStudents();
      studentListDiv.innerHTML = "";
      students.forEach(student => {
        const div = document.createElement("div");
        div.className = "student-card";
        div.innerHTML = `
          <span>${student.name} (${student.id}) - ${student.belt}</span>
          <button class="delete-btn" onclick="deleteStudentUI('${student.id}')">Delete</button>
        `;
        studentListDiv.appendChild(div);
      });
    }

    // Add student
    async function addStudentUI() {
      const name = document.getElementById("studentName").value;
      const belt = document.getElementById("studentBelt").value;
      const id = document.getElementById("studentId").value;

      if (!name || !belt || !id) return alert("Fill all fields");

      await addStudent(name, belt, id);
      document.getElementById("studentName").value = "";
      document.getElementById("studentBelt").value = "";
      document.getElementById("studentId").value = "";
      loadStudents();
    }

    // Delete student
    async function deleteStudentUI(id) {
      await deleteStudent(id);
      loadStudents();
    }

    // Load attendance
    async function loadAttendance() {
      const students = await getAllStudents();
      attendanceTable.innerHTML = "";
      const today = new Date().toISOString().split("T")[0];

      students.forEach(student => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${student.id}</td>
          <td>${student.name}</td>
          <td>${today}</td>
        `;
        attendanceTable.appendChild(row);
      });
    }

    // Start QR Scanner
    functio
